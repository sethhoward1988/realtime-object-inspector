<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="doc.html">
<link rel="import" href="app-globals.html">
<link rel="import" href="app-settings.html">

<polymer-element name="inspector-app">
  <template>
      <app-globals id="globals"></app-globals>
      <app-settings fileId="{{ fileIds }}"></app-settings>
      <div id="docs"></div>
  </template>
  <script>
    Polymer({
      ready: function () {
        this.util = new Utils();
        this.token = this.util.getParam('access_token');
        this.fileIds = this.util.getParam('ids');
        var splitIds = this.fileIds.split(',');
        var that = this;

        window.gapi.load('auth:client,drive-realtime,drive-share', {
          callback:  function() {
            gapi.auth.setToken({ access_token: that.token});
            that.registerTypes();
            for(var i = 0; i < splitIds.length; i++){
              var run = function loadDoc (fileId) {
                that.load(fileId);
              }(splitIds[i]);
            }
          }
        });
      },

      load: function (fileId) {
        var that = this;
        window.gapi.drive.realtime.load(
          fileId,
          function(doc){
            var docEl = document.createElement('collab-doc');
            that.$.globals.addDoc(fileId, doc);
            docEl.doc = doc;
            docEl.fileId = fileId;
            docEl.token = that.token;
            that.$.docs.appendChild(docEl);
          }, function(){
            throw new Error;
          }, function (e) {
        });
      },

      registerTypes: function () {
        // Register Types Here
        var Movie = function () {};
        Movie.prototype = {
          initialize: function (name, director) {
            this.name = name;
            this.director = director;
            this.notes = '';
            this.rating = '';
          }
        }

        var custom = gapi.drive.realtime.custom;
        custom.registerType(Movie, 'DemoMovie');
        Movie.prototype.name = custom.collaborativeField('name');
        Movie.prototype.director = custom.collaborativeField('director');
        Movie.prototype.notes = custom.collaborativeField('notes');
        Movie.prototype.rating = custom.collaborativeField('rating');
        custom.setInitializer(Movie, Movie.prototype.initialize);
      }
    });
  </script>
</polymer-element>
